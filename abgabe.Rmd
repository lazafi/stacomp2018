---
title: "StatComp 2018 WC"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


library(dplyr)
library(MASS)
library(rpart)
library(ggplot2)
library(gridExtra)

```

###Info Sources

https://en.wikipedia.org/wiki/Statistical_association_football_predictions



### Historic WC Data

* **Task 1.** Get familiar with the data using `str()`, `head()`, `table()`, `summary()`, etc. Describe the data in a few lines.

* **Task 2.** Write a function that generates the result of the game (W, D, L) from the vectors. How would you incorporate the information in the variable `Win.conditions`?

* **Task 3.** Explore the data set using summary statistics and illustrations. 

  - How often has every nation participated?
  - Create a table with the number of wins/draws/losses for ever nation.
  - How many goals were scored on average by ever nation?
  - etc.

* **Task 4.** Do you think this data set can be used to build a predictor function?

```{r, message=FALSE}

matches <- read.csv("data/WorldCupMatches.csv") 
head(matches)
str(matches)
summary(matches)
```



### FIFA Ranking Data

* **Task 5.** Get familiar with the data using `str()`, `head()`, `table()`, `summary()`, etc. 

* **Task 6.** What is the class of `fifa.ranking$rank_date`? Is this a problem? Can you change it to class `date` using `as.Date`? What difference does this make for e.g. plotting?

* **Task 7.** Plot the FIFA ranks for a selection of favorites
```{r }
favorites <- c("Germany", "Brazil", "Belgium", "France", "Argentinia")
```
If you use `ggplot()` don't forget to `scale_y_reverse()``


### Transfermarkt.de Data

* **Task 8.** Have a look at the following web site [https://www.transfermarkt.com/weltmeisterschaft-2018/startseite/pokalwettbewerb/WM18](https://www.transfermarkt.com/weltmeisterschaft-2018/startseite/pokalwettbewerb/WM18). Where can you find detailed information from the past world cups?

* **Task 9.** (voluntary) Browse the vignette of the following package:

```{r }
#library(rvest)
```

* **Task 10.** (voluntary) How can you scrape the relevant information of the following websites (in the order of the vector `participants`)?

```{r }
links.transfermarkt <- c(
  "https://www.transfermarkt.com/argentinien/startseite/verein/3437",
  "https://www.transfermarkt.com/australien/startseite/verein/3433",
  "https://www.transfermarkt.com/belgien/startseite/verein/3382",
  "https://www.transfermarkt.com/brasilien/startseite/verein/3439",
  "https://www.transfermarkt.com/kolumbien/startseite/verein/3816",
  "https://www.transfermarkt.com/costa-rica/startseite/verein/8497",
  "https://www.transfermarkt.com/kroatien/startseite/verein/3556",
  "https://www.transfermarkt.com/danemark/startseite/verein/3436",
  "https://www.transfermarkt.com/agypten/startseite/verein/3672",
  "https://www.transfermarkt.com/england/startseite/verein/3299",
  "https://www.transfermarkt.com/frankreich/startseite/verein/3377",
  "https://www.transfermarkt.com/deutschland/startseite/verein/3262",
  "https://www.transfermarkt.com/island/startseite/verein/3574",
  "https://www.transfermarkt.com/iran/startseite/verein/3582",
  "https://www.transfermarkt.com/japan/startseite/verein/3435",
  "https://www.transfermarkt.com/sudkorea/startseite/verein/3589",
  "https://www.transfermarkt.com/mexiko/startseite/verein/6303",
  "https://www.transfermarkt.com/marokko/startseite/verein/3575",
  "https://www.transfermarkt.com/nigeria/startseite/verein/3444",
  "https://www.transfermarkt.com/panama/startseite/verein/3577",
  "https://www.transfermarkt.com/peru/startseite/verein/3584",
  "https://www.transfermarkt.com/polen/startseite/verein/3442",
  "https://www.transfermarkt.com/portugal/startseite/verein/3300",
  "https://www.transfermarkt.com/russland/startseite/verein/3448",
  "https://www.transfermarkt.com/saudi-arabien/startseite/verein/3807",
  "https://www.transfermarkt.com/senegal/startseite/verein/3499",
  "https://www.transfermarkt.com/serbien/startseite/verein/3438",
  "https://www.transfermarkt.com/spanien/startseite/verein/3375",
  "https://www.transfermarkt.com/schweden/startseite/verein/3557",
  "https://www.transfermarkt.com/schweiz/startseite/verein/3384",
  "https://www.transfermarkt.com/tunesien/startseite/verein/3670",
  "https://www.transfermarkt.com/uruguay/startseite/verein/3449"
)
```

What kind of css selectors are there? [https://www.w3schools.com/cssref/css_selectors.asp](https://www.w3schools.com/cssref/css_selectors.asp) How can you use them to extract the information?

hint: use `read_html()`, `html_nodes()` with the css selectors ".item" or "td", `html_children()`, etc.


### Socio-economic Data

* **Task 11.** Get familiar with the data using `str()`, `head()`, `table()`, `summary()`, etc. Describe the data in a few lines. 

* **Task 12.** Link the FIFA Ranks with this data by means of the country names and generate a scatterplot of the rank against the population, gdp etc. Which of the socio economic variables contains some information about the teams performance?


### Evaluation

* **Task 13.** Implement the evaluation metric. This is a function with two arguments: the prediction matrix $R$ and a data structure with the true results $R_{true}$. Note, that this data structure should not be a matrix since two teams may compete twice against each other during the course of a world cup tournament. What data structure would you suggest?

* **Task 14.** Generate a matrix of random predictions to test this function. Don't forget, that this matrix is symmetric and that the diagonal should only contain NAs. 

* **Task 15.** Generate (hypothetic) true results and test the function of Task 14.

* **Task 16.** A completely naive predictor, which randomly predicts the outcome with equal probabilites, should serve as a benchmark. What is the expected rate of correct predictions?
  
### Prediction

  * **Task 17** Choose a (first) model for a predictor. Clearly state your modelling assumptions and any decisions you made also during the foramting of the data, e.g. 

    - use only results after 90 minutes.
    - use only data after 1994
    - which identifier was used to merge the data sets.

Since the data availability varies between data sets, clearly state how you want to fit and evaluate your predictor. The availability of the selected data sets is as follows:

    - Historic WC data is available since the 1930s
    - FIFA ranks are available since 1993, 
    - the full player's data is available for the 2018 world cup only,
    - the market value of a player is available since 2006.

For other sources of data the availability might be different. Thus, we need a good strategy for bulding a classifier and evaluating it.

If you want to use information such as scored goals, caps, etc. for every player, then the only possiblity would be the qualifiers. Where can be obtain the results?


* **Task 18** You do not have to use a statistical model, but if you do, you have to train it. This would require a trainings dataset. This training set would need include at least

- the result of the game
- general information about the game
- information about the home team
- information about the away team


* **Task 19** (voluntary) Create a list of pariticipating nations for every world cup and scrape their information from the follwing links:

[https://www.transfermarkt.de/weltmeisterschaft-2014/teilnehmer/pokalwettbewerb/WM14/saison_id/2013](https://www.transfermarkt.de/weltmeisterschaft-2014/teilnehmer/pokalwettbewerb/WM14/saison_id/2013)

[https://www.transfermarkt.de/weltmeisterschaft-2010/teilnehmer/pokalwettbewerb/WM10/saison_id/2009](https://www.transfermarkt.de/weltmeisterschaft-2010/teilnehmer/pokalwettbewerb/WM10/saison_id/2009)

[https://www.transfermarkt.de/weltmeisterschaft-2006/teilnehmer/pokalwettbewerb/WM06/saison_id/2005](https://www.transfermarkt.de/weltmeisterschaft-2006/teilnehmer/pokalwettbewerb/WM06/saison_id/2005)

[https://www.transfermarkt.de/weltmeisterschaft-2002/teilnehmer/pokalwettbewerb/WM02/saison_id/2001](https://www.transfermarkt.de/weltmeisterschaft-2002/teilnehmer/pokalwettbewerb/WM02/saison_id/2001)


####Possion Model

```{r, message=FALSE, out.width = '100%'}

teams.all <- c("Russia", "Portugal", "France", "Argentina", "Saudi Arabia", "Spain", "Australia", "Iceland", "Egypt", "Morocco", "Peru", "Croatia", "Uruguay", "Iran", "Denmark", "Nigeria", "Brazil", "Germany", "Belgium", "Poland", "Switzerland", "Sweden", "Panama", "Senegal", "Costa Rica", "Mexico", "Tunisia", "Colombia", "Serbia", "Korea Republic", "England", "Japan")


matches <- matches %>%
  filter(
      Away.Team.Name %in% teams.all | Home.Team.Name %in% teams.all,
      Year >= 1970
      )

some.team <- matches %>%
  filter(Home.Team.Name=="Argentina")

some.home.hist <- some.team %>%
  group_by(Home.Team.Goals) %>%
  summarize(density=n()/nrow(.)) %>%
  mutate(goals = Home.Team.Goals)
  
some.home.hist$pois <- dpois(some.home.hist$goals, mean(some.team$Home.Team.Goals))

ggplot(some.home.hist)  +
  geom_col(aes(x=goals,y=density, fill=as.factor("real"))) +
  geom_line(aes(x=goals,y=pois, fill=as.factor("poisson")), color="#f8766d", size=2) +
  scale_fill_manual(values=c("#f8766d","#04bfc4"), name="Verteilung") 


```

```{r, message=FALSE, out.width = '100%'}
some.away.hist <- some.team %>%
  group_by(Away.Team.Goals) %>%
  summarize(density=n()/nrow(.)) %>%
  mutate(goals = Away.Team.Goals)

some.away.hist$pois <- dpois(some.away.hist$goals, mean(some.team$Away.Team.Goals))

ggplot(some.away.hist)  +
  geom_col(aes(x=goals,y=density, fill=as.factor("real"))) +
  geom_line(aes(x=goals,y=pois, fill=as.factor("poisson")), color="#f8766d", size=2) +
  scale_fill_manual(values=c("#f8766d","#04bfc4"), name="Verteilung") 

```


```{r, message=FALSE, out.width = '100%'}
t.offensive <- matches %>%
  group_by(Home.Team.Goals) %>%
  summarize(density=n()/nrow(.)) %>%
  mutate(goals = Home.Team.Goals)

t.offensive$pois <- dpois(t.offensive$goals, mean(matches$Home.Team.Goals))

ggplot(t.offensive)  +
  geom_col(aes(x=goals,y=density, fill=as.factor("real"))) +
  geom_line(aes(x=goals,y=pois, fill=as.factor("poisson")), color="#f8766d", size=2) +
  scale_fill_manual(values=c("#f8766d","#04bfc4"), name="Verteilung") +
  scale_x_continuous(breaks=c(0,2,4,6,8,10))
```


```{r, message=FALSE, out.width = '100%'}
t.offensive <- matches %>%
  group_by(Home.Team.Goals) %>%
  summarize(density=n()/nrow(.)) %>%
  mutate(goals = Home.Team.Goals)

t.offensive$pois <- dpois(t.offensive$goals, mean(matches$Home.Team.Goals))

p1 <- ggplot(t.offensive)  +
  geom_col(aes(x=goals,y=density, fill=as.factor("real"))) +
  geom_line(aes(x=goals,y=pois, fill=as.factor("poisson")), color="#f8766d", size=2) +
  scale_fill_manual(values=c("#f8766d","#04bfc4"), name="Verteilung") +
  scale_x_continuous(breaks=c(0,2,4,6,8,10)) +
  guides(fill=FALSE)

## ALL away goals distribution (deffensive)
t.defensive <- matches %>%
  group_by(Away.Team.Goals) %>%
  summarize(density=n()/nrow(.)) %>%
  mutate(goals = Away.Team.Goals)

t.defensive$pois <- dpois(t.defensive$goals, mean(matches$Away.Team.Goals))

p2 <- ggplot(t.defensive)  +
  geom_col(aes(x=goals,y=density, fill=as.factor("real"))) +
  geom_line(aes(x=goals,y=pois, fill=as.factor("poisson")), color="#f8766d", size=2)  +
  scale_fill_manual(values=c("#f8766d","#04bfc4"), name="Verteilung") 


grid.arrange(p1, p2, ncol=2)
```

```{r, message=FALSE, out.width = '100%'}
#training the model

matches.a <- matches %>%
  transmute(
    team = Home.Team.Name,
    goals = Home.Team.Goals,
    opponent = Away.Team.Name,
  )
matches.b <- matches %>%
  transmute(
    team = Away.Team.Name,
    goals = Away.Team.Goals,
    opponent = Home.Team.Name,
  )

rest <- expand.grid(team = c("Panama", "Peru", "Iceland"),
                    opponent = c("Panama", "Peru", "Iceland"),
                    goals = 0
)

model.poisson <- rbind(matches.a, matches.b, rest) %>%
  glm(data=., goals ~ team + opponent, family="poisson")

summary(model.poisson)
```


```{r, message=FALSE, out.width = '100%'}
predict.wm <- function(model, home.team, away.team) {
  #model=model.poisson
  #home.team="Russia"
  #away.team="Italy"
    input <- data.frame(team=c(home.team, away.team),opponent=c(away.team, home.team))
    input$prediction <- predict(model, newdata=input, type="response")
    
    m <- dpois(0:10, input[1,]$prediction) %o%  dpois(0:10, input[2,]$prediction)
    
    r <- c(
      '1' = sum(m[lower.tri(m)]),  
      X = sum(diag(m)),
      '2' = sum(m[upper.tri(m)])
    )
    #max(home.prob, draw.prob, away.prob)
    #colname(max(r))
    names(which.max(r))
}

predict.matrix <- function(teams, model) {
  #teams <- teams.all
  #model <- model.poisson
  m <- matrix(0, nrow = length(teams), ncol = length(teams), dimnames = list(teams, teams))
  diag(m) <- NA

  for(j in 1:ncol(m)){
    for(i in 1:nrow(m)){
      if (i != j) {
        m[i,j] = predict.wm(model, colnames(m)[i], colnames(m)[j])
      }
    }
  } 
  m
}

evaluate.wm <- function(prediction, results) {
     results <- results %>%
     mutate(
       accurate = if (!is.na(result)) {result == prediction[home.team][away.team]} else { NA }
     )
   sum(results$accurate, na.rm=TRUE)/sum( !is.na( results$result ) ) 
}
```


```{r, message=FALSE, out.width = '100%'}
fifa.results <- read.csv("data/fifa-world-cup-2018-RussianStandardTime-Results.csv", stringsAsFactors=TRUE, strip.white=TRUE, na.strings = "") %>%
  transmute(
    home.team= Home.Team,
    away.team=Away.Team,
    result = res
  )

prediction <- predict.matrix(teams.all, model.poisson)

evaluate.wm(prediction, fifa.results)
```


  